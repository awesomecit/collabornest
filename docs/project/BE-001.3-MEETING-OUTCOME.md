# BE-001.3 Meeting Outcome - Distributed Locking Decisions

**Meeting Date**: Monday, November 18, 2025  
**Duration**: 25 minutes  
**Attendees**: Backend Lead (Antonio), PM/Frontend (Claudio)  
**Status**: ‚úÖ ALL DECISIONS APPROVED  
**Delivery**: Week 3 (Nov 25, 2025)

---

## üìä Executive Summary

**Approach**: YAGNI-driven - ship simplest working solution Week 3, defer complexity to future backlog.

**Core Principle**: Clean code > backward compatibility. Grace period for migrations, then kill deprecated patterns fast.

**Timeline Impact**: Zero delay - all decisions enable immediate Week 3 implementation.

---

## ‚úÖ APPROVED DECISIONS

### Decision 1: Viewer Permission Model ‚úÖ

**Decision**: **Option A - No WebSocket Permission Check**

**Implementation**:

- WebSocket validates JWT only (not resource-level permissions)
- Resource ACLs handled upstream (Auth service/Keycloak)
- Valid JWT + resource access ‚Üí Can join as viewer

**Week**: 3 (already implemented)

---

### Decision 2: Lock Upgrade Flow

**Decision**: **Option A - Deny**

**UX**: Toast "Document locked by [Dr. Smith]" ‚Üí User stays viewer

**Rationale**: Simplest (Week 3), rare conflicts in healthcare (2-3 users)

**Deferred**: Queue ‚Üí Future Backlog

**Week**: 3

---

### Decision 3: Disconnect Handling

**Decision**: **Option B - Grace Period 30 seconds**

**Implementation**: 30s grace ‚Üí reconnect preserves lock, else release

**Week**: 3

---

### Decision 4: Tabs Per User

**Decision**: **Option C - Single Tab Only**

**Implementation**: Check `userHasActiveLock()` ‚Üí Error if duplicate

**Rationale**: Simplest enforcement, typical single-monitor workflow

**Week**: 3

---

### Decision 5: Admin Override

**Decision**: **Option B - No Admin Override**

**Rationale**: YAGNI - feature not requested, no emergency scenario documented

**Week**: 3

---

### Decision 6: Lock TTL

**Decision**: **Option B - 5 minutes (300s)**

**Implementation**: `SET lock:doc:123:main userId EX 300 NX`

**Rationale**: Survives phone call (3min), doesn't block others for lunch

**Week**: 3

---

### Decision 7: Viewer Limits

**Decision**: **Option A - No Limit**

**Rationale**: YAGNI - WebSocket handles 100+ viewers easily

**Week**: 3

---

### Decision 8: Heartbeat

**Decision**: **Option B - 60 seconds**

**Implementation**: Heartbeat every 60s renews TTL (5 heartbeats before expiry)

**Week**: 3

---

### Decision 9: Backward Compatibility ‚ö°

**Decision**: **Option C - Warn + Kill Fast (2-week migration)**

**Timeline**:

- **Week 3**: Auto-convert `"doc:123"` ‚Üí `"doc:123:main"` + deprecation log
- **Week 4**: Frontend migrates all calls to explicit format
- **Week 5**: Remove auto-convert ‚Üí Only explicit format

**Rationale**: Clean code principle, 2-week grace period

**Required Knowledge**:

```typescript
// Must always track:
- Users connected (WebSocket level)
- Users in resource (document:123)
- Users in tab/section (document:123:section:5)
```

**Week**: 3 (support), 5 (kill)

---

## üéØ Implementation Checklist (Week 3)

### Backend (Antonio)

- [ ] **RedisLockService TDD Green** (2 days)
  - `acquireLock()`, `releaseLock()`, `renewLock()`, `getLockHolder()`
  - Single tab enforcement
  - Backward compat + deprecation log

- [ ] **WebSocket Lock Events** (1 day)
  - `lock_acquired`, `lock_released`, `lock_denied`
  - Disconnect handler (30s grace)

- [ ] **BDD Test Suite** (1 day)
  - 6 scenarios passing

- [ ] **API Documentation** (0.5 day)
  - Update `UI_TEAM_WEBSOCKET_API.md`

### Frontend (Claudio)

- [ ] **Lock UI** (2 days)
  - Toast on deny
  - Handle lock events

- [ ] **Heartbeat** (0.5 day)
  - Send every 60s

- [ ] **ResourceId Migration** (Week 4)
  - Update all calls to `"resource:id:main"` format

### DevOps

- [ ] **Environment Variables**

  ```env
  LOCK_TTL=300                # 5 minutes
  LOCK_HEARTBEAT_INTERVAL=60  # 60 seconds
  LOCK_GRACE_PERIOD=30        # 30 seconds
  LOCK_SINGLE_TAB=true
  ```

- [ ] **Redis Monitoring**
  - Active locks count
  - Deprecation warnings
  - Lock expiry rate

---

## üì¶ Future Backlog (NOT Week 3)

**Trigger**: Create tickets ONLY if real problem emerges.

| Feature            | Decision | Trigger                 | Priority |
| ------------------ | -------- | ----------------------- | -------- |
| **Lock Queue**     | 2-B      | Users complain          | P2       |
| **Multi-Tab**      | 4-B      | Dual-monitor workflow   | P3       |
| **Admin Override** | 5-A      | Emergency scenario      | P2       |
| **Viewer Limits**  | 7-B      | Performance >50 viewers | P3       |

**Backlog Review**: Week 4 retrospective (Nov 25), Week 8 review (Dec 16)

---

## üìà Success Metrics (Week 3)

### Functional

- [ ] Single editor enforced
- [ ] Lock TTL 5 min working
- [ ] Heartbeat 60s working
- [ ] Disconnect 30s grace working
- [ ] Toast "Locked by [User]" working
- [ ] Backward compat with warnings working

### Performance

- Lock acquire: <50ms
- Heartbeat: <10KB/min per user
- Disconnect detection: 30s ¬±5s

### Coverage

- 6 BDD scenarios: 100%
- Unit tests: >90%

---

## üöÄ Timeline

```
Week 3 (Nov 18-22): Implementation
‚îú‚îÄ Mon-Tue: RedisLockService TDD Green
‚îú‚îÄ Wed: WebSocket lock events
‚îú‚îÄ Thu: BDD tests + integration
‚îî‚îÄ Fri: Documentation + code review

Week 3 Delivery (Nov 25): Demo
‚îú‚îÄ Lock acquire/release ‚úÖ
‚îú‚îÄ Toast on deny ‚úÖ
‚îú‚îÄ Backward compat + warnings ‚úÖ
‚îî‚îÄ 6 BDD scenarios green ‚úÖ

Week 4 (Nov 25-29): Frontend Migration
‚îú‚îÄ Update resourceId format everywhere
‚îú‚îÄ Monitor deprecation logs ‚Üí 0
‚îî‚îÄ Prepare Week 5 cleanup

Week 5 (Dec 2): Kill Deprecated Code
‚îú‚îÄ Remove auto-convert
‚îú‚îÄ Only explicit format supported
‚îî‚îÄ Code clean (Antonio's principle) ‚úÖ
```

---

## üîç Monitoring

### Logs (Week 3-4)

```javascript
// Deprecation warnings:
logger.warn('DEPRECATED_RESOURCE_ID', { resourceId, clientId, timestamp });

// Lock events:
logger.info('LOCK_ACQUIRED', { userId, resourceId, ttl: 300 });
logger.info('LOCK_RELEASED', { userId, resourceId, reason: 'disconnect' });
logger.info('LOCK_DENIED', { userId, resourceId, holder });
```

### Metrics

- `locks.active.count` (gauge)
- `locks.acquire.duration` (histogram)
- `locks.expired.count` (counter)
- `locks.denied.count` (counter)
- `deprecated.format.count` (counter - should ‚Üí 0 by Week 4)

### Alerts

- ‚ö†Ô∏è Lock acquire >100ms (Redis slow)
- ‚ö†Ô∏è Deprecation warnings >10/min after Week 4
- üö® Lock denied rate >50% (UX problem)

---

## üìù Decision Summary Table

| Decision             | Choice        | Week | YAGNI Rationale            |
| -------------------- | ------------- | ---- | -------------------------- |
| 1. Viewer Permission | A (No check)  | 3    | Separation of concerns     |
| 2. Lock Upgrade      | A (Deny)      | 3    | Simplest, rare conflicts   |
| 3. Disconnect        | B (30s grace) | 3    | WiFi glitches vs fairness  |
| 4. Tabs Per User     | C (Single)    | 3    | Simplest, typical workflow |
| 5. Admin Override    | B (No)        | 3    | Feature not requested      |
| 6. Lock TTL          | B (5 min)     | 3    | Comfort vs blocking        |
| 7. Viewer Limits     | A (No limit)  | 3    | Problem doesn't exist      |
| 8. Heartbeat         | B (60s)       | 3    | Balanced, 5 pings/expiry   |
| 9. Backward Compat   | C (Warn+Kill) | 3‚Üí5  | Clean code, 2-week grace   |

---

## üìé Quick Reference

### Redis Schema

```
lock:{resourceType}:{id}:{section} ‚Üí userId
Example: lock:document:123:main ‚Üí user_abc123
TTL: 300s
```

### WebSocket Events

```javascript
// Client ‚Üí Server
socket.emit('acquire_lock', { resourceId: 'document:123:main' });
socket.emit('release_lock', { resourceId: 'document:123:main' });
socket.emit('heartbeat', { resourceId: 'document:123:main' });

// Server ‚Üí Client(s)
socket.emit('lock_acquired', { resourceId, userId, timestamp });
socket.emit('lock_released', { resourceId, reason: 'disconnect' });
socket.emit('lock_denied', { resourceId, holder: { id, name } });
```

### Environment Config

```env
# Week 3 Settings
LOCK_TTL=300
LOCK_HEARTBEAT_INTERVAL=60
LOCK_GRACE_PERIOD=30
LOCK_SINGLE_TAB=true

# Week 5 Remove These
LOCK_BACKWARD_COMPAT=true
LOCK_DEPRECATION_WARN=true
```

---

## ‚úÖ Approvals

- **Backend Lead (Antonio)**: ‚úÖ All decisions enable Week 3 delivery
- **PM/Frontend (Claudio)**: ‚úÖ UX acceptable, migration clear
- **Product Owner**: ‚úÖ YAGNI minimizes risk

---

## üîÑ Next Review

**Date**: Monday, November 25, 2025  
**Agenda**:

- Demo lock flow
- Redis performance metrics
- Deprecation log count
- Any deferred features needed?

---

**Document Status**: ‚úÖ FINAL  
**Version**: 1.0.0  
**Last Updated**: November 18, 2025  
**Ready for**: Implementation Week 3 üöÄ
