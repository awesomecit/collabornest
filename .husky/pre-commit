#!/bin/sh

# Load husky configuration
CONFIG_FILE=".husky-config.json"

# Check if config exists and hook is enabled
if [ -f "$CONFIG_FILE" ]; then
  ENABLED=$(node -p "try { require('./$CONFIG_FILE').hooks['pre-commit'].enabled } catch(e) { true }")
  if [ "$ENABLED" = "false" ]; then
    echo "Pre-commit hook disabled in configuration"
    exit 0
  fi
fi

echo "Running pre-commit checks..."

# Run lint-staged if configured
if [ -f "$CONFIG_FILE" ]; then
  RUN_LINT_STAGED=$(node -p "try { require('./$CONFIG_FILE').hooks['pre-commit'].runLintStaged } catch(e) { true }")
  if [ "$RUN_LINT_STAGED" = "true" ]; then
    echo "Linting staged files..."
    npm run pre-commit || exit 1
  fi
fi

# Run tests if configured (granular: unit, integration, e2e)
if [ -f "$CONFIG_FILE" ]; then
  node -p "
    try {
      const config = require('./$CONFIG_FILE');
      const tests = config.hooks['pre-commit'].tests || {};
      const suites = config.testSuites || {};
      let hasTests = false;

      if (tests.unit) {
        console.log('Running unit tests...');
        hasTests = true;
        process.exit(10);
      }
      if (tests.integration) {
        console.log('Running integration tests...');
        hasTests = true;
        process.exit(11);
      }
      if (tests.e2e) {
        console.log('Running e2e tests...');
        hasTests = true;
        process.exit(12);
      }
    } catch(e) { }
  "

  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 10 ]; then
    npm test || exit 1
  elif [ $EXIT_CODE -eq 11 ]; then
    npm run test:integration || exit 1
  elif [ $EXIT_CODE -eq 12 ]; then
    npm run test:e2e || exit 1
  fi
fi

echo "Pre-commit checks passed"
